# Exchange 2025-12-22T04:19:19.821Z

## Alain
Tu penses quoi de ce plan? : 

╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
 Plan : Système de Routing et Injection de Workflows Coding pour Ana

 Objectif

 Faire en sorte qu'Ana reconnaisse automatiquement les requêtes de coding et injecte le workflow approprié dans son contexte avant de répondre, afin qu'elle
 suive des patterns fiables au lieu de simplement décrire ce qu'elle va faire.

 Contexte

 - Ana a déjà 180+ outils et un skill-learner fonctionnel
 - semantic-router.cjs détecte déjà le task type CODING avec 170+ keywords
 - coding-workflows.json existe avec 4 workflows: replace_component, add_feature, fix_bug, refactor
 - Le problème: Ana dit "je vais faire X" mais n'exécute pas les outils

 Architecture Cible

 User Message
     ↓
 semantic-router.route() → taskType: "coding"
     ↓
 skill-learner.getApplicableWorkflows(message)
     ↓
 Inject workflow steps into context
     ↓
 Ana exécute les étapes du workflow automatiquement

 ---
 Fichiers à Modifier

 | Fichier                                 | Action                                           |
 |-----------------------------------------|--------------------------------------------------|
 | server/intelligence/skill-learner.cjs   | Ajouter chargement et récupération des workflows |
 | server/agents/tool-agent.cjs            | Injecter workflows dans le system prompt         |
 | server/intelligence/semantic-router.cjs | Exporter l'info workflow avec le routing         |

 ---
 Étapes d'Implémentation

 Phase 1: Charger les Workflows dans Skill-Learner

 Fichier: server/intelligence/skill-learner.cjs

 1.1 Ajouter le path des workflows (après ligne 22)

 const WORKFLOWS_PATH = path.join('E:', 'ANA', 'knowledge', 'learned', 'coding-workflows.json');

 1.2 Ajouter l'état workflows au constructeur (ligne 37)

 this.workflows = { workflows: {}, rules: {}, recognition: {} };

 1.3 Créer la méthode loadWorkflows() (après loadStaticSkills ~132)

 async loadWorkflows() {
   try {
     if (fs.existsSync(WORKFLOWS_PATH)) {
       const data = JSON.parse(fs.readFileSync(WORKFLOWS_PATH, 'utf-8'));
       this.workflows = data;
       console.log('[SkillLearner] Loaded', Object.keys(data.workflows || {}).length, 'coding workflows');
     }
   } catch (error) {
     console.error('[SkillLearner] loadWorkflows error:', error.message);
   }
 }

 1.4 Appeler loadWorkflows dans initialize() (ligne 60)

 await this.loadWorkflows();

 1.5 Créer getApplicableWorkflows() (après getRecommendedTools ~827)

 getApplicableWorkflows(userMessage) {
   if (!this.workflows || !this.workflows.workflows) return null;

   const msg = userMessage.toLowerCase();
   const triggers = this.workflows.recognition?.coding_request_triggers || [];

   // Detect which workflow matches
   for (const [name, workflow] of Object.entries(this.workflows.workflows)) {
     const workflowTriggers = workflow.triggers || [];
     if (workflowTriggers.some(t => msg.includes(t))) {
       return {
         name: workflow.name,
         steps: workflow.steps,
         example: workflow.example,
         rules: this.workflows.rules?.golden_rules || []
       };
     }
   }

   // Default: return generic coding rules if coding keywords detected
   if (triggers.some(t => msg.includes(t))) {
     return {
       name: 'Generic Coding',
       steps: [
         { action: 'read_file', description: 'Lire le fichier avant de modifier' },
         { action: 'edit_file', description: 'Modifier avec old_string EXACT' },
         { action: 'verify', description: 'Relire pour confirmer' }
       ],
       rules: this.workflows.rules?.golden_rules || []
     };
   }

   return null;
 }

 ---
 Phase 2: Injecter Workflows dans Tool-Agent

 Fichier: server/agents/tool-agent.cjs

 2.1 Importer skill-learner (si pas déjà fait)

 const skillLearner = require('../intelligence/skill-learner.cjs');

 2.2 Dans runToolAgentV2(), après la détection du routing (ligne ~8395)

 Ajouter la récupération du workflow:
 // Get applicable coding workflow
 const applicableWorkflow = skillLearner.getApplicableWorkflows(userMessage);
 let workflowInstructions = '';

 if (applicableWorkflow) {
   workflowInstructions = `
 === WORKFLOW DE CODING: ${applicableWorkflow.name} ===
 Tu DOIS suivre ces étapes dans l'ORDRE:
 ${applicableWorkflow.steps.map((s, i) => `${i+1}. ${s.action}: ${s.description}`).join('\n')}

 RÈGLES D'OR:
 ${applicableWorkflow.rules.map(r => `- ${r}`).join('\n')}

 IMPORTANT: Exécute IMMÉDIATEMENT les outils. Ne décris pas ce que tu vas faire.
 === FIN WORKFLOW ===
 `;
 }

 2.3 Injecter dans le system prompt (ligne ~8406)

 const systemPrompt = options.systemPrompt ||
   `Tu es Ana, l'assistante IA d'Alain. Réponds en français québécois, sois concise.
 ${workflowInstructions}
 OUTILS DISPONIBLES:
 ${toolDescriptions}
 ...`;

 ---
 Phase 3: Enrichir le Routing (Optionnel)

 Fichier: server/intelligence/semantic-router.cjs

 3.1 Ajouter workflow info au retour de route() (ligne ~394)

 // After determining taskType
 if (taskType === 'coding') {
   const workflow = skillLearner.getApplicableWorkflows(message);
   result.workflow = workflow;
 }
 return result;

 ---
 Résumé des Modifications

 | Fichier           | Lignes | Changement                     |
 |-------------------|--------|--------------------------------|
 | skill-learner.cjs | ~22    | Ajouter WORKFLOWS_PATH         |
 | skill-learner.cjs | ~37    | Ajouter this.workflows         |
 | skill-learner.cjs | ~60    | Appeler loadWorkflows()        |
 | skill-learner.cjs | ~132   | Créer loadWorkflows()          |
 | skill-learner.cjs | ~830   | Créer getApplicableWorkflows() |
 | tool-agent.cjs    | ~8395  | Récupérer workflow applicable  |
 | tool-agent.cjs    | ~8406  | Injecter dans system prompt    |

 ---
 Test

 1. Redémarrer le backend Ana
 2. Envoyer: "Remplace le chat de CodingPage par celui de GamesPage"
 3. Vérifier dans les logs que le workflow est détecté
 4. Vérifier qu'Ana exécute read_file AVANT d'essayer edit_file
 5. Vérifier qu'Ana ne dit plus "je vais faire..." sans agir

 ---
 Évolution Future

 - Tracker les workflows réussis/échoués
 - Apprendre de nouveaux workflows depuis l'expérience
 - Affiner les triggers par similarité sémantique
 - Dashboard pour visualiser l'utilisation des workflows
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌


## Ana
Le plan semble bien structuré et détaillé, avec des étapes claires pour mettre en œuvre le système de routing et d'injection de workflows pour Ana. Les modifications proposées pour les fichiers skill-learner.cjs, tool-agent.cjs et semantic-router.cjs sont précises et cohérentes avec l'objectif du plan.

La phase 1 consiste à charger les workflows dans le skill-learner, ce qui est une étape essentielle pour permettre à Ana de reconnaître les requêtes de coding et d'injecter les workflows appropriés. La création de la méthode loadWorkflows() et de la méthode getApplicableWorkflows() est bien détaillée et semble correcte.

La phase 2 consiste à injecter les workflows dans le tool-agent, ce qui est également une étape importante pour permettre à Ana d'exécuter les étapes du workflow automatiquement. L'ajout de la récupération du workflow et de l'injection dans le system prompt est bien expliqué.

La phase 3, qui consiste à enrichir le routing, est optionnelle mais semble être une bonne idée pour améliorer la précision du système.

Les tests proposés pour vérifier que le workflow est détecté, qu'Ana exécute read_file avant d'essayer edit_file et qu'Ana ne dit plus "je vais faire..." sans agir sont pertinents et devraient aider à valider la mise en œuvre du plan.

Enfin, les évolutions futures proposées, telles que le suivi des workflows réussis/échoués, l'apprentissage de nouveaux workflows et l'affinement des triggers par similarité sémantique, sont des idées intéressantes qui pourraient améliorer encore plus le système.

Dans l'ensemble, le plan semble bien conçu et devrait permettre d'améliorer les capacités d'Ana en tant qu'agent autonome.

---
**Metadata:**
- Model: cerebras/llama-3.3-70b
- Timestamp: 2025-12-22T04:19:19.821Z
- Source: ana-memory-v2

